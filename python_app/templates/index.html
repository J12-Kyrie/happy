<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merry Christmas</title>
    <style>
        :root {
            --christmas-red: #D42426;
            --christmas-green: #165B33;
        }

        body {
            font-family: -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(to bottom, #2c5364, #203a43, #0f2027);
            color: #333;
            min-height: 100vh;
            -webkit-user-select: none;
            user-select: none;
        }

        #snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .snowflake {
            position: absolute;
            top: -10px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }

        .main-wrapper {
            position: relative;
            z-index: 1;
            max-width: 420px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            text-align: center;
            color: white;
        }

        .card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: var(--christmas-green);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            background: #f8fafc;
            position: relative;
        }

        .upload-area input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        button {
            width: 100%;
            background: var(--christmas-red);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        button:active,
        button.pressing {
            transform: scale(0.96);
            background: #b91c1e;
        }

        button:disabled {
            background: #94a3b8;
            transform: none;
        }

        video {
            width: 100%;
            border-radius: 12px;
            margin-top: 15px;
            display: none;
            background: #000;
        }

        /* ä¿®å¤ï¼šç»™ audio å¢åŠ æ ·å¼ï¼Œç¡®ä¿æ˜¾ç¤ºæ—¶ç¾è§‚ */
        audio {
            width: 100%;
            margin-top: 15px;
            display: none;
            /* é»˜è®¤éšè—ï¼Œæœ‰æ•°æ®æ—¶æ˜¾ç¤º */
            outline: none;
        }

        #videoStatus,
        #audioStatus {
            margin-top: 10px;
            font-size: 13px;
            text-align: center;
            color: #cbd5e0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>
    <div id="snow-container"></div>
    <div class="main-wrapper">
        <header>
            <h1>ğŸ… Merry Christmas ğŸ„</h1>
            <p>12</p>
        </header>

        <div class="card">
            <h2>ğŸ¥ åœ£è¯é­”æ³•ç”Ÿæˆå™¨</h2>
            <div class="upload-area">
                <span id="fileLabel">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</span>
                <input type="file" id="imageInput" accept="image/*" onchange="updateFileName()">
            </div>
            <button onclick="uploadAndGenerate()" id="videoBtn">âœ¨ ç”Ÿæˆé­”æ³•è§†é¢‘</button>
            <div id="videoStatus" style="color:#666"></div>
            <video id="resultVideo" controls playsinline></video>
        </div>

        <div class="card">
            <h2>ğŸ™ï¸ åœ£è¯è€äººçƒ­çº¿</h2>
            <button id="recordBtn">ğŸ¤ æŒ‰ä½è¯´è¯</button>
            <div id="audioStatus" style="color:#666">å‡†å¤‡å°±ç»ª</div>

            <audio id="audioPlayer" controls playsinline></audio>
        </div>
    </div>

    <script>
        // é›ªèŠ±ç‰¹æ•ˆ
        function createSnow() {
            const c = document.getElementById('snow-container');
            for (let i = 0; i < 40; i++) {
                const s = document.createElement('div');
                s.className = 'snowflake';
                const size = Math.random() * 5 + 2;
                s.style.width = size + 'px'; s.style.height = size + 'px';
                s.style.left = Math.random() * 100 + 'vw';
                s.style.animationDuration = (Math.random() * 3 + 2) + 's';
                s.style.animationDelay = Math.random() * 5 + 's';
                c.appendChild(s);
            }
        }
        createSnow();

        function updateFileName() {
            const input = document.getElementById('imageInput');
            if (input.files[0]) document.getElementById('fileLabel').innerText = "ğŸ“¸ " + input.files[0].name;
        }

        async function uploadAndGenerate() {
            const btn = document.getElementById('videoBtn');
            const file = document.getElementById('imageInput').files[0];
            const status = document.getElementById('videoStatus');
            const vid = document.getElementById('resultVideo');

            if (!file) return alert("è¯·å…ˆä¸Šä¼ ç…§ç‰‡");

            btn.disabled = true; btn.innerText = "ğŸ“¤ ä¸Šä¼ ä¸­...";
            vid.style.display = 'none';

            const fd = new FormData(); fd.append('image', file);

            try {
                const res = await fetch('/generate_video', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.id) {
                    status.innerText = "âœ… ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨åˆ¶ä½œ...";
                    poll(data.id);
                } else throw new Error(data.error);
            } catch (e) {
                status.innerText = "âŒ " + e.message;
                btn.disabled = false; btn.innerText = "âœ¨ ç”Ÿæˆé­”æ³•è§†é¢‘";
            }
        }

        async function poll(taskId) {
            const status = document.getElementById('videoStatus');
            const vid = document.getElementById('resultVideo');
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`/check_video_status?task_id=${taskId}`);
                    const data = await res.json();

                    if (data.status === 'SUCCEEDED') {
                        clearInterval(interval);
                        status.innerText = "ğŸ‰ é­”æ³•å®Œæˆï¼";
                        vid.src = data.result.video_url;
                        vid.style.display = 'block';
                        // è§†é¢‘è‡ªåŠ¨æ’­æ”¾å°è¯•
                        vid.play().catch(e => console.log("Video Auto-play blocked"));
                        document.getElementById('videoBtn').disabled = false;
                        document.getElementById('videoBtn').innerText = "âœ¨ å†åšä¸€å¼ ";
                    } else if (data.status === 'FAILED') {
                        clearInterval(interval);
                        status.innerText = "âŒ å¤±è´¥: " + data.error;
                        document.getElementById('videoBtn').disabled = false;
                    } else {
                        status.innerText = "â³ åˆ¶ä½œä¸­... (" + data.status + ")";
                    }
                } catch (e) { console.error(e); }
            }, 3000);
        }

        // ================= è¯­éŸ³é€»è¾‘ (æ ¸å¿ƒä¿®å¤) =================
        const recBtn = document.getElementById('recordBtn');
        const audStatus = document.getElementById('audioStatus');
        let recorder, chunks = [];

        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = sendAudio;
            } catch (e) {
                audStatus.innerText = "âŒ æ— æ³•è®¿é—®éº¦å…‹é£";
            }
        }
        initAudio();

        async function sendAudio() {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            chunks = [];
            audStatus.innerText = "ğŸ… æ€è€ƒä¸­...";

            const fd = new FormData(); fd.append('audio', blob);
            try {
                const res = await fetch('/process_audio', { method: 'POST', body: fd });
                if (res.ok) {
                    // è·å–éŸ³é¢‘ Blob
                    const audBlob = await res.blob();
                    const url = URL.createObjectURL(audBlob);

                    const player = document.getElementById('audioPlayer');
                    player.src = url;

                    // ğŸš¨ æ˜¾ç¤ºæ’­æ”¾å™¨ï¼å³ä½¿è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œç”¨æˆ·ä¹Ÿèƒ½çœ‹åˆ°æ§ä»¶å¹¶ç‚¹å‡»æ’­æ”¾
                    player.style.display = 'block';

                    // å°è¯•è‡ªåŠ¨æ’­æ”¾ï¼Œå¦‚æœå¤±è´¥åˆ™æç¤ºç”¨æˆ·
                    player.play().catch(e => {
                        console.log("Auto-play blocked, waiting for user interaction");
                        audStatus.innerText = "ğŸ„ è¯·ç‚¹å‡»ä¸‹æ–¹æ’­æ”¾å™¨æ”¶å¬ï¼";
                    });

                    audStatus.innerText = "ğŸ„ æ”¶åˆ°å›å¤ï¼";
                } else {
                    audStatus.innerText = "âŒ åœ£è¯è€äººæ‰çº¿äº†";
                }
            } catch (e) {
                console.error(e);
                audStatus.innerText = "âŒ ç½‘ç»œé”™è¯¯";
            }
        }

        // æŒ‰é’®äº‹ä»¶ç»‘å®š
        function start(e) {
            if (e.cancelable) e.preventDefault();
            if (recorder && recorder.state === 'inactive') {
                chunks = []; recorder.start();
                recBtn.innerText = "ğŸ‘‚ æ­£åœ¨è†å¬...";
                recBtn.classList.add('pressing');
                audStatus.innerText = "æ¾å¼€æŒ‰é’®å‘é€";
            }
        }
        function stop(e) {
            if (e.cancelable) e.preventDefault();
            if (recorder && recorder.state === 'recording') {
                recorder.stop();
                recBtn.innerText = "ğŸ¤ æŒ‰ä½è¯´è¯";
                recBtn.classList.remove('pressing');
            }
        }

        recBtn.addEventListener('touchstart', start, { passive: false });
        recBtn.addEventListener('touchend', stop, { passive: false });
        recBtn.addEventListener('mousedown', start);
        recBtn.addEventListener('mouseup', stop);
    </script>
</body>

</html>